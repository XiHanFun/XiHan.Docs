# 基础应用

## 概述

**XiHan.BasicApp** 是一个基于 XiHan.Framework 构建的企业级应用示例，展示了如何使用框架构建完整的企业管理系统。它提供了权限管理、组织架构、系统管理等核心功能模块，可以作为您项目的起点。

## 核心特性

### 完整的权限管理（RBAC）

基于角色的访问控制系统：

- **用户管理** - 用户创建、编辑、禁用
- **角色管理** - 角色定义、权限分配
- **权限管理** - 细粒度的权限控制
- **资源管理** - 系统资源和操作定义
- **菜单管理** - 动态菜单配置

### 组织架构管理

完善的组织架构功能：

- **部门管理** - 部门树形结构
- **层级关系** - 上下级关系管理
- **用户归属** - 用户与部门关联
- **权限继承** - 部门权限继承

### 多租户支持

内置多租户架构：

- **租户管理** - 租户创建和配置
- **数据隔离** - 租户数据完全隔离
- **租户配置** - 独立的租户设置
- **租户生命周期** - 租户启用、禁用、删除

### 审计日志

全方位的审计追踪：

- **访问日志** - 记录用户访问行为
- **操作日志** - 记录用户操作
- **登录日志** - 登录、登出记录
- **异常日志** - 系统异常记录
- **API 日志** - API 调用追踪

### 系统管理

丰富的系统管理功能：

- **字典管理** - 系统字典和字典项
- **配置管理** - 系统配置参数
- **文件管理** - 文件上传和存储
- **任务调度** - 定时任务管理
- **通知管理** - 系统通知

### 消息通知

多渠道消息通知：

- **站内通知** - 应用内消息推送
- **邮件通知** - 邮件发送
- **短信通知** - 短信发送

### 代码生成

自动化代码生成工具：

- **表结构分析** - 数据库表结构读取
- **代码生成** - 自动生成增删改查代码
- **模板管理** - 自定义代码模板
- **生成历史** - 代码生成记录

## 架构设计

### 分层架构

应用采用清晰的分层架构：

```
┌──────────────────────────┐
│   WebHost（Web 主机）     │  应用入口
├──────────────────────────┤
│   Modules（功能模块）     │  业务模块
│   ├── Rbac              │  权限管理模块
│   └── CodeGeneration    │  代码生成模块
├──────────────────────────┤
│   Core（应用核心）        │  核心配置
│   └── Web.Core          │  Web 扩展
├──────────────────────────┤
│   Framework（开发框架）   │  框架层
└──────────────────────────┘
```

### 模块化设计

应用采用模块化设计：

- **独立模块** - 每个功能是独立的模块
- **模块依赖** - 清晰的模块依赖关系
- **模块复用** - 模块可以在不同项目中复用
- **模块扩展** - 易于添加新模块

### DDD 实现

遵循领域驱动设计：

- **聚合根** - 用户、角色、权限等核心聚合
- **实体** - 领域实体建模
- **领域服务** - 跨聚合的业务逻辑
- **领域事件** - 领域内的事件通知
- **仓储模式** - 数据访问抽象

## 功能模块

### 权限管理模块（Rbac）

#### 用户管理

用户信息管理功能：

- 用户创建和编辑
- 用户基本信息
- 用户状态管理（启用/禁用）
- 用户角色分配
- 用户部门归属
- 密码修改和重置
- 用户会话管理

#### 角色管理

角色定义和管理：

- 角色创建和编辑
- 角色权限分配
- 角色层级关系
- 角色数据权限
- 角色继承
- 预置角色

#### 权限管理

细粒度权限控制：

- 权限定义
- 资源权限
- 操作权限
- 权限组
- 权限继承
- 权限检查

#### 资源管理

系统资源定义：

- 资源类型（菜单、按钮、API）
- 资源树形结构
- 资源与权限关联
- 资源状态管理

#### 菜单管理

动态菜单配置：

- 菜单树形结构
- 菜单路由配置
- 菜单图标
- 菜单排序
- 菜单权限
- 菜单状态

#### 部门管理

组织架构管理：

- 部门树形结构
- 部门层级关系
- 部门负责人
- 部门成员
- 部门权限

#### 租户管理

多租户功能：

- 租户创建
- 租户配置
- 租户状态
- 租户资源配额
- 租户数据隔离

#### 会话管理

用户会话控制：

- 会话创建
- 会话状态
- 会话超时
- 强制下线
- 单点登录

#### 约束规则

业务约束管理：

- 规则定义
- 规则类型
- 规则验证
- 规则引擎

### 日志审计

#### 访问日志

记录用户访问：

- 访问时间
- 访问路径
- 访问 IP
- 浏览器信息
- 访问结果

#### 操作日志

记录用户操作：

- 操作类型
- 操作对象
- 操作内容
- 操作时间
- 操作结果

#### 登录日志

记录登录行为：

- 登录时间
- 登录 IP
- 登录设备
- 登录方式
- 登录结果

#### 异常日志

记录系统异常：

- 异常类型
- 异常消息
- 堆栈信息
- 发生时间
- 请求信息

#### API 日志

记录 API 调用：

- 请求路径
- 请求方法
- 请求参数
- 响应结果
- 响应时间

### 系统管理

#### 字典管理

系统字典维护：

- 字典类型
- 字典项
- 字典排序
- 字典状态
- 字典缓存

#### 配置管理

系统配置维护：

- 配置分组
- 配置项
- 配置值
- 配置描述
- 配置刷新

#### 文件管理

文件上传和管理：

- 文件上传
- 文件存储
- 文件访问
- 文件分类
- 文件清理

#### 任务调度

定时任务管理：

- 任务创建
- 任务调度
- 任务执行
- 任务日志
- 任务监控

#### 通知管理

系统通知功能：

- 通知创建
- 通知发送
- 通知类型
- 通知模板
- 通知记录

### 消息服务

#### 邮件服务

邮件发送功能：

- 邮件模板
- 邮件发送
- 发送记录
- 发送状态
- 发送失败重试

#### 短信服务

短信发送功能：

- 短信模板
- 短信发送
- 发送记录
- 发送状态
- 短信网关集成

### OAuth 认证

OAuth 2.0 支持：

- OAuth 应用管理
- 授权码管理
- 访问令牌管理
- 刷新令牌
- 第三方登录

### 审核流程

审核工作流：

- 审核定义
- 审核流程
- 审核记录
- 审核状态
- 审核通知

### 代码生成模块

#### 数据源管理

数据库连接管理：

- 数据源配置
- 数据库类型
- 连接测试
- 表结构读取

#### 代码生成表

表配置管理：

- 表选择
- 表配置
- 字段配置
- 字段映射
- 生成选项

#### 生成模板

代码模板管理：

- 模板类型
- 模板内容
- 模板变量
- 模板预览
- 模板导入导出

#### 生成历史

代码生成记录：

- 生成时间
- 生成内容
- 生成配置
- 生成结果
- 代码下载

## 数据库设计

### 权限相关表

- `sys_user` - 用户表
- `sys_role` - 角色表
- `sys_permission` - 权限表
- `sys_resource` - 资源表
- `sys_menu` - 菜单表
- `sys_user_role` - 用户角色关联表
- `sys_role_permission` - 角色权限关联表
- `sys_role_hierarchy` - 角色层级表

### 组织相关表

- `sys_department` - 部门表
- `sys_tenant` - 租户表
- `sys_user_session` - 用户会话表

### 系统管理表

- `sys_dict` - 字典表
- `sys_dict_item` - 字典项表
- `sys_config` - 配置表
- `sys_file` - 文件表
- `sys_file_storage` - 文件存储表
- `sys_task` - 任务表
- `sys_task_log` - 任务日志表

### 日志审计表

- `sys_access_log` - 访问日志表
- `sys_operation_log` - 操作日志表
- `sys_login_log` - 登录日志表
- `sys_exception_log` - 异常日志表
- `sys_api_log` - API 日志表
- `sys_audit_log` - 审计日志表

### 消息通知表

- `sys_notification` - 通知表
- `sys_email` - 邮件表
- `sys_sms` - 短信表

### 审核流程表

- `sys_review` - 审核表
- `sys_review_log` - 审核日志表

### OAuth 表

- `sys_oauth_app` - OAuth 应用表
- `sys_oauth_code` - OAuth 授权码表
- `sys_oauth_token` - OAuth 令牌表

### 代码生成表

- `sys_code_gen_data_source` - 数据源表
- `sys_code_gen_table` - 代码生成表
- `sys_code_gen_table_column` - 代码生成表列
- `sys_code_gen_template` - 代码生成模板表
- `sys_code_gen_history` - 代码生成历史表

## 技术实现

### 数据访问

使用 SqlSugar ORM：

- 仓储模式
- 工作单元
- 自动审计
- 软删除
- 多租户隔离

### 缓存策略

使用 Redis 缓存：

- 用户信息缓存
- 权限信息缓存
- 字典数据缓存
- 配置信息缓存
- 分布式缓存

### 事件处理

使用事件总线：

- 领域事件
- 集成事件
- 异步处理
- 事件持久化

### 后台任务

使用任务调度：

- 定时任务
- 延时任务
- 重复任务
- 任务监控

### 认证授权

JWT 令牌认证：

- JWT 生成和验证
- 刷新令牌机制
- 权限检查
- 资源授权

## 部署指南

### 环境要求

**后端环境**：
- .NET 10 SDK
- PostgreSQL 14+ 或 MySQL 8.0+
- Redis 6.0+

**前端环境**：
- Node.js 24.0.2+
- pnpm 10.26.2+

### 数据库配置

1. 创建数据库
2. 配置连接字符串
3. 运行数据库迁移
4. 导入初始数据

### 应用配置

**数据库配置**：
```json
{
  "ConnectionStrings": {
    "Default": "Server=127.0.0.1;Port=5432;Database=XiHanBasicApp;User Id=postgres;Password=your_password;"
  }
}
```

**Redis 配置**：
```json
{
  "Redis": {
    "Configuration": "127.0.0.1:6379",
    "InstanceName": "XiHan:",
    "DefaultDatabase": 0
  }
}
```

### 启动应用

**后端启动**：
```bash
cd backend/src/main/XiHan.BasicApp.WebHost
dotnet run
```

**前端启动**：
```bash
cd frontend
pnpm install
pnpm dev
```

### 默认账户

初始管理员账户：
- 用户名：admin
- 密码：请查看数据种子文件

::: warning 安全提示
生产环境部署前，请务必修改默认密码。
:::

### Docker 部署

支持 Docker 容器化部署：

```bash
# 构建镜像
docker build -t xihanbasicapp .

# 运行容器
docker run -d -p 8080:8080 xihanbasicapp
```

### 生产部署建议

**安全配置**：
- 修改默认密码
- 配置 HTTPS
- 启用防火墙
- 配置 CORS

**性能优化**：
- 启用缓存
- 配置连接池
- 启用压缩
- CDN 加速

**监控运维**：
- 配置日志收集
- 启用健康检查
- 配置告警
- 定期备份

## 扩展开发

### 添加新模块

1. 创建模块类
2. 定义模块依赖
3. 注册模块服务
4. 实现模块功能

### 添加新功能

1. 定义聚合根和实体
2. 创建领域服务
3. 实现仓储接口
4. 创建应用服务
5. 添加 API 控制器

### 自定义权限

1. 定义权限常量
2. 创建权限资源
3. 配置权限菜单
4. 实现权限检查

### 自定义审计

1. 继承审计实体
2. 配置审计字段
3. 实现审计处理器

## 最佳实践

### 代码组织

- 按功能模块组织
- 遵循 DDD 分层
- 保持代码简洁
- 编写单元测试

### 数据访问

- 使用仓储模式
- 使用工作单元
- 避免直接操作数据库
- 合理使用缓存

### 权限控制

- 最小权限原则
- 资源级别控制
- 数据权限隔离
- 定期审计

### 性能优化

- 合理使用缓存
- 避免 N+1 查询
- 使用异步编程
- 定期性能分析

## 常见问题

### 如何添加新用户？

在用户管理页面，点击"新增"按钮，填写用户信息并分配角色。

### 如何配置权限？

1. 在资源管理中定义资源
2. 在权限管理中创建权限
3. 在角色管理中分配权限给角色
4. 在用户管理中分配角色给用户

### 如何启用多租户？

多租户功能默认启用，在租户管理中创建新租户即可。

### 如何自定义菜单？

在菜单管理中配置菜单树，设置菜单路由和权限。

## 更多资源

- [API 文档](https://api.xihanfun.com)
- [在线演示](https://demo.xihanfun.com)
- [视频教程](https://space.bilibili.com/xihanfun)
- [问题反馈](https://github.com/XiHanFun/XiHan.BasicApp/issues)
